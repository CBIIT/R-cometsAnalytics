---
title: "Comets Analytics: vignette"
author: "Ewy Mathe, Ella Temprosa"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Introduction

COMETS Analytics support all cohort-specific analyses of the COMETS consortium.

This collaborative work is done via the COMETS harmonization group activities. For more information, see the [COMETS website] (http://epi.grants.cancer.gov/comets/).


## Data Input Format
The required input file shoudl be in excel format with the following 5 sheets: 

  1. Metabolites - from harmonized metabolites output
  2. SubjectMetabolites - abundances in columns and subject in rows
  3. SubjectData - other exposure and adjustment variables
  4. VarMap - maps the variables needed to conduct the cohort specific analysis. Specify the name of variables under CohortVariable column. if the VarReference has the same name in the cohort, leave blank
  5. Models - models used to conduct COMETS analysis. Outcomes, exposures and adjustment can specify multiple covariates delimited by spaces (ie: age bmi).

An example input file is available **HERE**.

## Analysis Workflow for correlation analysis

###1. Load Data
The first step of the analysis is to load in the data with the *getModelData()* function.  Input for this function is an Excel spreadsheet, per the description above.  

```{r}
# Retrieve the full path of the input data
dir <- system.file("extdata", package="COMETS", mustWork=TRUE)
csvfile <- file.path(dir, "cometsInputAge.xlsx")
# Read in and process the input data
exmetabdata <- COMETS::readCOMETSinput(csvfile)
```

To plot some the distribution of variances for each metabolite:
```{r}
COMETS::plotVar(exmetabdata,titlesize=12)
```

To plot the distribution of minimum/missing values:
```{r}
COMETS::plotMinvalues(exmetabdata,titlesize=12)
```

###2. Get Model Data
There are 2 ways to specify your model, batch or interactive.
In Batch mode, models are specified in your input file. The model information needs to be read in with the function *getModelData()* and processed so the software knows which models to run.  Input for this function is the data input in the previous step:

```{r}
exmodeldata <- COMETS::getModelData(exmetabdata,modbatch="1.1 Unadjusted")
```
In Interactive mode, models are specified as parameters. The model information needs to be read in with the function *getModelData()* and processed so the software knows which models to run.  Input for this function is the data input in the previous step:

```{r}
exmodeldata <- COMETS::getModelData(exmetabdata,modelspec="Interactive",colvars=c("age","bmi"))
```

###3. Run Correlation Analysis
The correlation analysis is run by calling the function *getCorr()*.  This function runs the model(s) that is(are) defined in the input data (Models tab).  

```{r}
excorrdata  <- COMETS::getCorr(exmodeldata,exmetabdata,"DPP")
```

The output of the correlation analysis can then be compiled and output to a CSV file with the following function:
```{r}
COMETS::OutputCSVResults(filename="corr",dataf=excorrdata,cohort="DPP")
```

To view the first 3 lines of the correlation analysis output, simply type:
```{r}
COMETS::showCorr(excorrdata,nlines=3)
```

To display the heatmap of the resulting correlation matrix, use the showheatmap function.
```{r in-text-fig}
#COMETS::showHeatmap(excorrdata,plothgt=350,plotwid=400)
```
\
\
\
To display the hierarchical clustering of the resulting correlation matrix, use the showHClust function. Requires at least 2 rows and 2 columns in the correlation matrix.

```{r}
exmodeldata<-COMETS::getModelData(exmetabdata,modelspec = "Interactive",colvars = "age bmi")
excorrdata  <- COMETS::getCorr(exmodeldata,exmetabdata,"DPP")
COMETS::showHClust(excorrdata)
```

Results can be written to an output CSV file with the following command:

``{r}
COMETS::OutputCSVResults("Model1",excordata,cohort="")
```

###4. Run Analysis on all models defined in the input Excell sheet
All models desginated in the input file can be run with one command, and individual output CSV files or correlation results will be written in the current directory by default. The function returns a list of resulting data frames.

```{r}
allresults <- COMETS::runAllModels(exmetabdata)

```

sessionInfo()
```
